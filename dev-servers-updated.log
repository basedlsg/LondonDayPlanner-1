
> rest-express@1.0.0 dev:both
> concurrently "npm run dev" "npm run dev:client"

[0] 
[0] > rest-express@1.0.0 dev
[0] > NODE_ENV=development tsx server/index.ts
[0] 
[1] 
[1] > rest-express@1.0.0 dev:client
[1] > vite
[1] 
[1] 
[1]   VITE v5.4.19  ready in 165 ms
[1] 
[1]   ➜  Local:   http://localhost:3000/
[1]   ➜  Network: use --host to expose
[0] 🔧 [config.ts] Creating new Config instance.
[0] 🔧 [config.ts] Config constructor starting...
[0] 🔧 [config.ts] process.env.GOOGLE_PLACES_API_KEY at constructor start: NOT SET
[0] 🔧 [config.ts] process.env.GEMINI_API_KEY at constructor start: NOT SET
[0] 🔧 [config.ts] loadApiKeys() starting...
[0] 🔧 [config.ts] Loading GEMINI_API_KEY from process.env: NOT SET
[0] 🔧 [config.ts] Stored GEMINI_API_KEY in this.apiKeys: NOT SET (stored as empty string)
[0] 🔧 [config.ts] Loading GOOGLE_PLACES_API_KEY from process.env: NOT SET
[0] 🔧 [config.ts] Stored GOOGLE_PLACES_API_KEY in this.apiKeys: NOT SET (stored as empty string)
[0] 🔧 [config.ts] Loading WEATHER_API_KEY from process.env: NOT SET
[0] 🔧 [config.ts] Stored WEATHER_API_KEY in this.apiKeys: NOT SET (stored as empty string)
[0] 🔧 [config.ts] Loading GOOGLE_CLIENT_ID from process.env: NOT SET
[0] 🔧 [config.ts] Stored GOOGLE_CLIENT_ID in this.apiKeys: NOT SET (stored as empty string)
[0] 🔧 [config.ts] loadApiKeys() finished.
[0] 🔧 [config.ts] initializeFeatureFlags() starting...
[0] [config.ts isApiKeyValid] Key: GEMINI_API_KEY, Present in this.apiKeys: false, Valid (has length): false
[0] 🚫 [config.ts] AI_PROCESSING feature flag DISABLED (enabled: true, keysMet: false).
[0] [config.ts isApiKeyValid] Key: GEMINI_API_KEY, Present in this.apiKeys: false, Valid (has length): false
[0] 🚫 [config.ts] USE_GEMINI feature flag DISABLED (enabled: true, keysMet: false).
[0] [config.ts isApiKeyValid] Key: WEATHER_API_KEY, Present in this.apiKeys: false, Valid (has length): false
[0] 🚫 [config.ts] WEATHER_AWARE feature flag DISABLED (enabled: true, keysMet: false).
[0] [config.ts isApiKeyValid] Key: GOOGLE_PLACES_API_KEY, Present in this.apiKeys: false, Valid (has length): false
[0] 🚫 [config.ts] PLACES_API feature flag DISABLED (enabled: true, keysMet: false).
[0] 🔧 [config.ts] initializeFeatureFlags() finished.
[0] 🔧 [config.ts] Config constructor finished.
[0] [CityRegistry] Registered city: London (slug: london)
[0] [CityRegistry] Registered city: New York City (slug: nyc)
[0] [CityRegistry] Registered city: Boston (slug: boston)
[0] [CityRegistry] Registered city: Austin (slug: austin)
[0] [CityRegistry] City configurations loading process completed. Registry size: 4
[0] [CityRegistry] Registered slugs: london, nyc, boston, austin
[0] AI_PROCESSING feature flag status: false
[0] 🔧 Loading environment variables...
[0] 📄 .env file path: /Users/carlos/LondonDayPlanner-1/.env
[0] 📄 .env file exists: true
[0] ✅ Environment variables loaded by dotenv (keys found): [
[0]   'DATABASE_URL',
[0]   'GOOGLE_PLACES_API_KEY',
[0]   'GEMINI_API_KEY',
[0]   'WEATHER_API_KEY',
[0]   'GOOGLE_CLIENT_ID',
[0]   'GOOGLE_CLIENT_SECRET'
[0] ]
[0] 🔍 Environment check (process.env):
[0]    DATABASE_URL present: true
[0]    GOOGLE_PLACES_API_KEY present: true
[0]    GOOGLE_PLACES_API_KEY length: 39
[0]    GEMINI_API_KEY present: true
[0] 🔧 Initializing application configuration...
[0] 🔄 [config.ts] Config.recheckEnvironment() called. Forcing reload of API keys and features...
[0] 🔧 [config.ts] loadApiKeys() starting...
[0] 🔧 [config.ts] Loading GEMINI_API_KEY from process.env: SET (length: 39)
[0] 🔧 [config.ts] Stored GEMINI_API_KEY in this.apiKeys: SET (length: 39)
[0] 🔧 [config.ts] Loading GOOGLE_PLACES_API_KEY from process.env: SET (length: 39)
[0] 🔧 [config.ts] Stored GOOGLE_PLACES_API_KEY in this.apiKeys: SET (length: 39)
[0] 🔧 [config.ts] Loading WEATHER_API_KEY from process.env: SET (length: 32)
[0] 🔧 [config.ts] Stored WEATHER_API_KEY in this.apiKeys: SET (length: 32)
[0] 🔧 [config.ts] Loading GOOGLE_CLIENT_ID from process.env: SET (length: 72)
[0] 🔧 [config.ts] Stored GOOGLE_CLIENT_ID in this.apiKeys: SET (length: 72)
[0] 🔧 [config.ts] loadApiKeys() finished.
[0] 🔧 [config.ts] initializeFeatureFlags() starting...
[0] [config.ts isApiKeyValid] Key: GEMINI_API_KEY, Present in this.apiKeys: true, Valid (has length): true
[0] ✨ [config.ts] AI_PROCESSING feature flag ENABLED.
[0] [config.ts isApiKeyValid] Key: GEMINI_API_KEY, Present in this.apiKeys: true, Valid (has length): true
[0] ✨ [config.ts] USE_GEMINI feature flag ENABLED.
[0] [config.ts isApiKeyValid] Key: WEATHER_API_KEY, Present in this.apiKeys: true, Valid (has length): true
[0] ✨ [config.ts] WEATHER_AWARE feature flag ENABLED.
[0] [config.ts isApiKeyValid] Key: GOOGLE_PLACES_API_KEY, Present in this.apiKeys: true, Valid (has length): true
[0] ✨ [config.ts] PLACES_API feature flag ENABLED.
[0] 🔧 [config.ts] initializeFeatureFlags() finished.
[0] 🔄 [config.ts] Environment recheck complete. Logging new status:
[0] 🔧 [config.ts] Current Application configuration: {
[0]   features: {
[0]     AI_PROCESSING: true,
[0]     USE_GEMINI: true,
[0]     WEATHER_AWARE: true,
[0]     PLACES_API: true
[0]   },
[0]   apiKeysPresent: {
[0]     GEMINI_API_KEY: true,
[0]     GOOGLE_PLACES_API_KEY: true,
[0]     WEATHER_API_KEY: true,
[0]     GOOGLE_CLIENT_ID: true
[0]   },
[0]   environment: 'development'
[0] }
[0] 🔧 [config.ts] Config initialize() called.
[0] 🔧 [config.ts] Current Application configuration: {
[0]   features: {
[0]     AI_PROCESSING: true,
[0]     USE_GEMINI: true,
[0]     WEATHER_AWARE: true,
[0]     PLACES_API: true
[0]   },
[0]   apiKeysPresent: {
[0]     GEMINI_API_KEY: true,
[0]     GOOGLE_PLACES_API_KEY: true,
[0]     WEATHER_API_KEY: true,
[0]     GOOGLE_CLIENT_ID: true
[0]   },
[0]   environment: 'development'
[0] }
[0] ⚠️  SESSION_SECRET not set, using fallback. SET THIS FOR PRODUCTION!
[0] 🗄️  Testing database connection...
[0] 🗄️  Initializing database instance with Neon driver...
[0] ✅ Database instance initialized successfully with Neon.
[0] ✅ Database connection successful
[0] 🔌 WebSocket service initialized
[0] 🚀 Server running on http://localhost:5001
[0] 🔧 Environment: development
[0] 🗄️  Database: Connected
[0] 🔑 Google Places API Key: Configured
[0] 🔑 Gemini API Key: Configured
[0] 🔌 WebSocket: Available at ws://localhost:5001/ws
[0] [CityRegistry] getAllCities called, registry size: 4
[0] GET /api/cities 200 3ms
[0] GET /api/auth/me 401 1ms
[0] [CityRegistry] getAllCities called, registry size: 4
[0] GET /api/cities 304 0ms
[0] GET /api/auth/me 401 0ms
[0] 📝 [/:city/plan] City-specific plan request for: London
[0] Query: I have a lunch in Mayfair 12 -- would like a place with nice fish. 
[0]   Afterwards I would like to work at a nearby coffee shop. Before going to 
[0]   Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could
[0]    you help me choose one?
[0] 🚀 [/:city/plan] Creating city-aware plan for London
[0] 🏙️ Creating plan for city: london
[0] 🚀 Creating plan for query: I have a lunch in Mayfair 12 -- would like a place with nice fish. 
[0]   Afterwards I would like to work at a nearby coffee shop. Before going to 
[0]   Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could
[0]    you help me choose one?
[0] [NLP] Processing query with context for city: London
[0] 🔄 [nlp-fixed] Attempting lazy AI initialization for new Gemini processor...
[0] 🤖 [nlp-fixed] Checking AI_PROCESSING feature flag status: true
[0] 🔑 [nlp-fixed] GEMINI_API_KEY validation: true
[0] ✅ [nlp-fixed] Initializing Gemini API with valid API key
[0] ✅ [nlp-fixed] Gemini API successfully initialized
[0] Attempting to process query with new Gemini processor
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:00",
[0]       "endTime": "18:30",
[0]       "activity": "Work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "Drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "bufferAfter": 0,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "Lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 1,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[{"activity":"Drinks with friends","bufferAfter":0,"bufferBefore":15,"duration":120,"isFixed":true,"location":"Chelsea","time":"19:00"}],"fixedTimeEntries":[{"activity":"Lunch","location":"Mayfair","searchParameters":{"cuisine":"Seafood","specificRequirements":[],"venueType":"restaurant"},"time":"12:00","venuePreference":"restaurant with nice fish","venueRequirements":[]}],"flexibleTimeEntries":[],"preferences":{"budget":"moderate","interests":[]},"specialRequests":[],"timeBlocks":[{"activity":"Work","endTime":"18:30","location":"Mayfair","searchParameters":{"specificRequirements":[],"venueType":"cafe"},"startTime":"13:00","venueRequirements":[]}],"travelGroup":{"adults":1,"children":0}},"processingTimeMs":4620,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 08:00\n    Date: 2025-06-03\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?\n    ","temperature":0.2},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:00\",\n      \"endTime\": \"18:30\",\n      \"activity\": \"Work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"Drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"bufferAfter\": 0,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"Lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"specificRequirements\": [],\n        \"cuisine\": \"Seafood\",\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": null,\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 1,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"3b535597-93ef-4189-a294-376db8100a62","status":"success","timestamp":"2025-06-02T23:55:41.260Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?"}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:00",
[0]       "endTime": "18:30",
[0]       "activity": "Work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "Drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "bufferAfter": 0,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "Lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 1,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4986,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 08:00\n    Date: 2025-06-03\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?\n    ","temperature":0.2},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:00\",\n      \"endTime\": \"18:30\",\n      \"activity\": \"Work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"Drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"bufferAfter\": 0,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"Lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"specificRequirements\": [],\n        \"cuisine\": \"Seafood\",\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": null,\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 1,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"3b535597-93ef-4189-a294-376db8100a62","status":"error","timestamp":"2025-06-02T23:55:41.626Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?"}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":5303,"rawRequest":{"temperature":0.2},"service":"ai-interaction-logger","sessionId":"3b535597-93ef-4189-a294-376db8100a62","status":"error","timestamp":"2025-06-02T23:55:41.943Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?"}
[0] Gemini processing attempt failed at temperature 0.2: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:00",
[0]       "endTime": "18:30",
[0]       "activity": "work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "bufferAfter": 0,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "pace": "moderate"
[0]   },
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[{"activity":"drinks with friends","bufferAfter":0,"bufferBefore":15,"duration":120,"isFixed":true,"location":"Chelsea","time":"19:00"}],"fixedTimeEntries":[{"activity":"lunch","location":"Mayfair","searchParameters":{"cuisine":"Seafood","venueType":"restaurant"},"time":"12:00","venuePreference":"restaurant with nice fish","venueRequirements":[]}],"flexibleTimeEntries":[],"preferences":{"pace":"moderate"},"specialRequests":[],"timeBlocks":[{"activity":"work","endTime":"18:30","location":"Mayfair","searchParameters":{"venueType":"cafe"},"startTime":"13:00","venueRequirements":[]}],"travelGroup":{}},"processingTimeMs":4064,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 08:00\n    Date: 2025-06-03\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?\n    ","temperature":0.4},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:00\",\n      \"endTime\": \"18:30\",\n      \"activity\": \"work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\"\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"bufferAfter\": 0,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": \"Seafood\"\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"pace\": \"moderate\"\n  },\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"3b535597-93ef-4189-a294-376db8100a62","status":"success","timestamp":"2025-06-02T23:55:46.118Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?"}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:00",
[0]       "endTime": "18:30",
[0]       "activity": "work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "bufferAfter": 0,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "pace": "moderate"
[0]   },
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4225,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 08:00\n    Date: 2025-06-03\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?\n    ","temperature":0.4},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:00\",\n      \"endTime\": \"18:30\",\n      \"activity\": \"work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\"\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"bufferAfter\": 0,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": \"Seafood\"\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"pace\": \"moderate\"\n  },\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"3b535597-93ef-4189-a294-376db8100a62","status":"error","timestamp":"2025-06-02T23:55:46.279Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?"}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4402,"rawRequest":{"temperature":0.4},"service":"ai-interaction-logger","sessionId":"3b535597-93ef-4189-a294-376db8100a62","status":"error","timestamp":"2025-06-02T23:55:46.456Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?"}
[0] Gemini processing attempt failed at temperature 0.4: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:00",
[0]       "endTime": "18:30",
[0]       "activity": "work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "pace": "moderate"
[0]   },
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[{"activity":"drinks with friends","bufferBefore":15,"duration":120,"isFixed":true,"location":"Chelsea","time":"19:00"}],"fixedTimeEntries":[{"activity":"lunch","location":"Mayfair","searchParameters":{"cuisine":"Seafood","venueType":"restaurant"},"time":"12:00","venuePreference":"restaurant with nice fish","venueRequirements":[]}],"flexibleTimeEntries":[],"preferences":{"pace":"moderate"},"specialRequests":[],"timeBlocks":[{"activity":"work","endTime":"18:30","location":"Mayfair","searchParameters":{"venueType":"cafe"},"startTime":"13:00","venueRequirements":[]}],"travelGroup":{}},"processingTimeMs":3976,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 08:00\n    Date: 2025-06-03\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?\n    ","temperature":0.7},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:00\",\n      \"endTime\": \"18:30\",\n      \"activity\": \"work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\"\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": \"Seafood\"\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"pace\": \"moderate\"\n  },\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"3b535597-93ef-4189-a294-376db8100a62","status":"success","timestamp":"2025-06-02T23:55:50.531Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?"}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:00",
[0]       "endTime": "18:30",
[0]       "activity": "work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "pace": "moderate"
[0]   },
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4132,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 08:00\n    Date: 2025-06-03\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?\n    ","temperature":0.7},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:00\",\n      \"endTime\": \"18:30\",\n      \"activity\": \"work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\"\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": \"Seafood\"\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"pace\": \"moderate\"\n  },\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"3b535597-93ef-4189-a294-376db8100a62","status":"error","timestamp":"2025-06-02T23:55:50.687Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?"}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4299,"rawRequest":{"temperature":0.7},"service":"ai-interaction-logger","sessionId":"3b535597-93ef-4189-a294-376db8100a62","status":"error","timestamp":"2025-06-02T23:55:50.854Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?"}
[0] Gemini processing attempt failed at temperature 0.7: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] [32minfo[39m: AI Interaction {"errorDetails":"Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","service":"ai-interaction-logger","sessionId":"3b535597-93ef-4189-a294-376db8100a62","status":"error","timestamp":"2025-06-02T23:55:50.953Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n   you help me choose one?"}
[0] New Gemini processor unavailable or failed, falling back to original method
[0] Converting Gemini result to app format: null
[0] 📝 Parsed request from cache/fetch: {
[0]   startLocation: '51.5074,-0.1278',
[0]   destinations: [],
[0]   fixedTimes: [],
[0]   preferences: { type: undefined, requirements: [] }
[0] }
[0] 📍 Using explicit start location from NLP: 51.5074,-0.1278
[0] 📍 Determined initial search/start location: 51.5074,-0.1278
[0] 🔧 NLP returned empty fixedTimes and activities, creating fallback activity based on original query.
[0] 🔧 Fallback activity created: [
[0]   {
[0]     description: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. \n' +
[0]       '  Afterwards I would like to work at a nearby coffee shop. Before going to \n' +
[0]       '  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n' +
[0]       '   you help me choose one?',
[0]     location: '51.5074,-0.1278',
[0]     time: '08:00',
[0]     searchParameters: {
[0]       type: 'pub',
[0]       searchTerm: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. \n' +
[0]         '  Afterwards I would like to work at a nearby coffee shop. Before going to \n' +
[0]         '  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n' +
[0]         '   you help me choose one?',
[0]       keywords: [],
[0]       minRating: 0,
[0]       requireOpenNow: true
[0]     },
[0]     requirements: []
[0]   }
[0] ]
[0] Parsed time "08:00" to normalized time "08:00" and Europe/London time: 8:00 AM (2025-06-02 08:00:00 GMT+1)
[0] [SERVICE DEBUG _processGeneralActivities] Called with 1 activities.
[0] Processing 1 general activities (no fixed times)
[0] Processing general activity: I have a lunch in Mayfair 12 -- would like a place with nice fish. 
[0]   Afterwards I would like to work at a nearby coffee shop. Before going to 
[0]   Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could
[0]    you help me choose one?
[0] Search options for general activity at "51.5074,-0.1278": {
[0]   type: 'pub',
[0]   keywords: [],
[0]   searchTerm: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. \n' +
[0]     '  Afterwards I would like to work at a nearby coffee shop. Before going to \n' +
[0]     '  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n' +
[0]     '   you help me choose one?',
[0]   minRating: 0,
[0]   requireOpenNow: true,
[0]   citySlug: 'london'
[0] }
[0] 🔍 [enhancedPlaceSearch] Starting enhanced search with options: {
[0]   query: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. \n' +
[0]     '  Afterwards I would like to work at a nearby coffee shop. Before going to \n' +
[0]     '  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n' +
[0]     '   you help me choose one?',
[0]   location: '51.5074,-0.1278',
[0]   keywords: [],
[0]   type: 'pub',
[0]   preferences: {
[0]     type: 'pub',
[0]     searchTerm: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. \n' +
[0]       '  Afterwards I would like to work at a nearby coffee shop. Before going to \n' +
[0]       '  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could\n' +
[0]       '   you help me choose one?',
[0]     keywords: [],
[0]     minRating: 0,
[0]     requireOpenNow: true
[0]   },
[0]   cityContext: { name: 'London', slug: 'london', timezone: 'Europe/London' }
[0] }
[0] 🏙️ [Area Intelligence] Recommending Fitzrovia for pub (score: 40)
[0]    Reasons: Known for pub, Nearby
[0] 🤖 [Gemini] Enhanced query: "best pub in Fitzrovia cocktails"
[0] 📍 [enhancedPlaceSearch] Using city center for "london"
[0] 🎯 [enhancedPlaceSearch] Using location bias: 51.5074,-0.1278 with radius 25000m
[0] 🌐 [enhancedPlaceSearch] Searching with query: "best pub in Fitzrovia cocktails"
[0] 🏙️ [enhancedPlaceSearch] After city filtering: 4 venues remain for London
[0] ✅ [enhancedPlaceSearch] Found 4 places with ratings
[0] 🎲 [enhancedPlaceSearch] Selected venue (with variety): {
[0]   name: 'The Royal Cocktail Exchange',
[0]   rating: 4.9,
[0]   address: '31 Windmill St, London W1T 2JN, United Kingdom'
[0] }
[0] 🔄 [enhancedPlaceSearch] Alternatives: [
[0]   { name: 'Murder Inc. Cocktails', rating: 4.9 },
[0]   { name: 'The Black Horse - Pub & Cocktail Bar', rating: 4.7 },
[0]   {
[0]     name: 'The Cocktail Club - Cocktail Bar in Fitzrovia',
[0]     rating: 4.5
[0]   }
[0] ]
[0] Found place for general activity: The Royal Cocktail Exchange
[0] Added general activity to itinerary: The Royal Cocktail Exchange at 2025-06-02T17:00:00.000Z
[0] DbStorage (with logging): Creating itinerary (anonymous)
[0] DbStorage (with logging): Error creating itinerary: NeonDbError: column "title" of relation "itineraries" does not exist
[0]     at execute (file:///Users/carlos/LondonDayPlanner-1/node_modules/@neondatabase/serverless/index.mjs:1556:55)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at NeonHttpPreparedQuery.execute (/Users/carlos/LondonDayPlanner-1/node_modules/src/neon-http/session.ts:68:18)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:100:27)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:512:22)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:300:32)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25) {
[0]   severity: 'ERROR',
[0]   code: '42703',
[0]   detail: undefined,
[0]   hint: undefined,
[0]   position: '34',
[0]   internalPosition: undefined,
[0]   internalQuery: undefined,
[0]   where: undefined,
[0]   schema: undefined,
[0]   table: undefined,
[0]   column: undefined,
[0]   dataType: undefined,
[0]   constraint: undefined,
[0]   file: 'parse_target.c',
[0]   line: '1066',
[0]   routine: 'checkInsertTargets',
[0]   sourceError: undefined
[0] }
[0] Using in-memory fallback for createItinerary due to database error
[0] Successfully created itinerary "I have a lunch in Mayfair 12 -- would like a place with nice fish. 
[0]   Afterwards I would like to work at a nearby coffee shop. Before going to 
[0]   Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could
[0]    you help me choose one? in London" for London with ID: 1
[0] [Weather] Fetching weather for 51.52,-0.13
[0] [Weather] Success with OpenWeatherMap
[0] 🌤️ [/:city/plan] Retrieved weather data for itinerary
[0] 🕒 [/:city/plan] Place scheduledTime: 2025-06-02T17:00:00.000Z
[0] 🌍 [/:city/plan] Using timezone: Europe/London
[0] 🕒 [/:city/plan] Formatted time: 6:00 PM
[0] 📤 [/:city/plan] Sending response with 1 venues
[0] POST /api/london/plan 200 16543ms
[0] 📝 [/:city/plan] City-specific plan request for: London
[0] Query: I have a lunch in Mayfair 12 -- would like a place with nice fish. 
[0]   Afterwards I would like to work at a nearby coffee shop. Before going to 
[0]   Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- 
[0] 🚀 [/:city/plan] Creating city-aware plan for London
[0] 🏙️ Creating plan for city: london
[0] 🚀 Creating plan for query: I have a lunch in Mayfair 12 -- would like a place with nice fish. 
[0]   Afterwards I would like to work at a nearby coffee shop. Before going to 
[0]   Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- 
[0] [NLP] Processing query with context for city: London
[0] Attempting to process query with new Gemini processor
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:00",
[0]       "endTime": "17:30",
[0]       "activity": "Work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "Drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "Lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "pace": "moderate"
[0]   },
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[{"activity":"Drinks with friends","bufferBefore":15,"duration":120,"isFixed":true,"location":"Chelsea","time":"19:00"}],"fixedTimeEntries":[{"activity":"Lunch","location":"Mayfair","searchParameters":{"cuisine":"Seafood","venueType":"restaurant"},"time":"12:00","venuePreference":"restaurant with nice fish","venueRequirements":[]}],"flexibleTimeEntries":[],"preferences":{"pace":"moderate"},"specialRequests":[],"timeBlocks":[{"activity":"Work","endTime":"17:30","location":"Mayfair","searchParameters":{"venueType":"cafe"},"startTime":"13:00","venueRequirements":[]}],"travelGroup":{}},"processingTimeMs":4010,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 08:00\n    Date: 2025-06-03\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- \n    ","temperature":0.2},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:00\",\n      \"endTime\": \"17:30\",\n      \"activity\": \"Work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\"\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"Drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"Lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": \"Seafood\"\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"pace\": \"moderate\"\n  },\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"52327b09-c1fd-40b9-956c-092d313d9fb0","status":"success","timestamp":"2025-06-02T23:56:08.203Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- "}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:00",
[0]       "endTime": "17:30",
[0]       "activity": "Work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "Drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "Lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "pace": "moderate"
[0]   },
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4333,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 08:00\n    Date: 2025-06-03\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- \n    ","temperature":0.2},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:00\",\n      \"endTime\": \"17:30\",\n      \"activity\": \"Work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\"\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"Drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"Lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": \"Seafood\"\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"pace\": \"moderate\"\n  },\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"52327b09-c1fd-40b9-956c-092d313d9fb0","status":"error","timestamp":"2025-06-02T23:56:08.526Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- "}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4623,"rawRequest":{"temperature":0.2},"service":"ai-interaction-logger","sessionId":"52327b09-c1fd-40b9-956c-092d313d9fb0","status":"error","timestamp":"2025-06-02T23:56:08.816Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- "}
[0] Gemini processing attempt failed at temperature 0.2: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:00",
[0]       "endTime": "18:30",
[0]       "activity": "Work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "Drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "bufferAfter": 0,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "Lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 1,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[{"activity":"Drinks with friends","bufferAfter":0,"bufferBefore":15,"duration":120,"isFixed":true,"location":"Chelsea","time":"19:00"}],"fixedTimeEntries":[{"activity":"Lunch","location":"Mayfair","searchParameters":{"cuisine":"Seafood","specificRequirements":[],"venueType":"restaurant"},"time":"12:00","venuePreference":"restaurant with nice fish","venueRequirements":[]}],"flexibleTimeEntries":[],"preferences":{"budget":"moderate","interests":[]},"specialRequests":[],"timeBlocks":[{"activity":"Work","endTime":"18:30","location":"Mayfair","searchParameters":{"specificRequirements":[],"venueType":"cafe"},"startTime":"13:00","venueRequirements":[]}],"travelGroup":{"adults":1,"children":0}},"processingTimeMs":4659,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 08:00\n    Date: 2025-06-03\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- \n    ","temperature":0.4},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:00\",\n      \"endTime\": \"18:30\",\n      \"activity\": \"Work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"Drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"bufferAfter\": 0,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"Lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"specificRequirements\": [],\n        \"cuisine\": \"Seafood\",\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": null,\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 1,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"52327b09-c1fd-40b9-956c-092d313d9fb0","status":"success","timestamp":"2025-06-02T23:56:13.561Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- "}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:00",
[0]       "endTime": "18:30",
[0]       "activity": "Work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "Drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "bufferAfter": 0,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "Lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 1,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4949,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 08:00\n    Date: 2025-06-03\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- \n    ","temperature":0.4},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:00\",\n      \"endTime\": \"18:30\",\n      \"activity\": \"Work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"Drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"bufferAfter\": 0,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"Lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"specificRequirements\": [],\n        \"cuisine\": \"Seafood\",\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": null,\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 1,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"52327b09-c1fd-40b9-956c-092d313d9fb0","status":"error","timestamp":"2025-06-02T23:56:13.852Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- "}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":5240,"rawRequest":{"temperature":0.4},"service":"ai-interaction-logger","sessionId":"52327b09-c1fd-40b9-956c-092d313d9fb0","status":"error","timestamp":"2025-06-02T23:56:14.142Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- "}
[0] Gemini processing attempt failed at temperature 0.4: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:00",
[0]       "endTime": "18:30",
[0]       "activity": "Work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "Lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant",
[0]         "specificRequirements": []
[0]       }
[0]     },
[0]     {
[0]       "time": "19:00",
[0]       "activity": "Drinks with friends",
[0]       "location": "Chelsea",
[0]       "venuePreference": "cocktail bar",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 1,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[],"fixedTimeEntries":[{"activity":"Lunch","location":"Mayfair","searchParameters":{"cuisine":"Seafood","specificRequirements":[],"venueType":"restaurant"},"time":"12:00","venuePreference":"restaurant with nice fish","venueRequirements":[]},{"activity":"Drinks with friends","location":"Chelsea","searchParameters":{"specificRequirements":[],"venueType":"bar"},"time":"19:00","venuePreference":"cocktail bar","venueRequirements":[]}],"flexibleTimeEntries":[],"preferences":{"budget":"moderate","interests":[]},"specialRequests":[],"timeBlocks":[{"activity":"Work","endTime":"18:30","location":"Mayfair","searchParameters":{"specificRequirements":[],"venueType":"cafe"},"startTime":"13:00","venueRequirements":[]}],"travelGroup":{"adults":1,"children":0}},"processingTimeMs":4803,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 08:00\n    Date: 2025-06-03\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- \n    ","temperature":0.7},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:00\",\n      \"endTime\": \"18:30\",\n      \"activity\": \"Work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    \n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"Lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"specificRequirements\": [],\n        \"cuisine\": \"Seafood\",\n        \"priceLevel\": null\n      }\n    },\n    {\n      \"time\": \"19:00\",\n      \"activity\": \"Drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": \"cocktail bar\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": null,\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 1,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"52327b09-c1fd-40b9-956c-092d313d9fb0","status":"success","timestamp":"2025-06-02T23:56:19.042Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- "}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:00",
[0]       "endTime": "18:30",
[0]       "activity": "Work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "Lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant",
[0]         "specificRequirements": []
[0]       }
[0]     },
[0]     {
[0]       "time": "19:00",
[0]       "activity": "Drinks with friends",
[0]       "location": "Chelsea",
[0]       "venuePreference": "cocktail bar",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 1,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":5099,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 08:00\n    Date: 2025-06-03\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- \n    ","temperature":0.7},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:00\",\n      \"endTime\": \"18:30\",\n      \"activity\": \"Work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    \n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"Lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"specificRequirements\": [],\n        \"cuisine\": \"Seafood\",\n        \"priceLevel\": null\n      }\n    },\n    {\n      \"time\": \"19:00\",\n      \"activity\": \"Drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": \"cocktail bar\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": null,\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 1,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"52327b09-c1fd-40b9-956c-092d313d9fb0","status":"error","timestamp":"2025-06-02T23:56:19.338Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- "}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":5377,"rawRequest":{"temperature":0.7},"service":"ai-interaction-logger","sessionId":"52327b09-c1fd-40b9-956c-092d313d9fb0","status":"error","timestamp":"2025-06-02T23:56:19.616Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- "}
[0] Gemini processing attempt failed at temperature 0.7: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] [32minfo[39m: AI Interaction {"errorDetails":"Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","service":"ai-interaction-logger","sessionId":"52327b09-c1fd-40b9-956c-092d313d9fb0","status":"error","timestamp":"2025-06-02T23:56:19.708Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. \n  Afterwards I would like to work at a nearby coffee shop. Before going to \n  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- "}
[0] New Gemini processor unavailable or failed, falling back to original method
[0] Converting Gemini result to app format: null
[0] 📝 Parsed request from cache/fetch: {
[0]   startLocation: '51.5074,-0.1278',
[0]   destinations: [],
[0]   fixedTimes: [],
[0]   preferences: { type: undefined, requirements: [] }
[0] }
[0] 📍 Using explicit start location from NLP: 51.5074,-0.1278
[0] 📍 Determined initial search/start location: 51.5074,-0.1278
[0] 🔧 NLP returned empty fixedTimes and activities, creating fallback activity based on original query.
[0] 🔧 Fallback activity created: [
[0]   {
[0]     description: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. \n' +
[0]       '  Afterwards I would like to work at a nearby coffee shop. Before going to \n' +
[0]       '  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- ',
[0]     location: '51.5074,-0.1278',
[0]     time: '08:00',
[0]     searchParameters: {
[0]       type: 'pub',
[0]       searchTerm: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. \n' +
[0]         '  Afterwards I would like to work at a nearby coffee shop. Before going to \n' +
[0]         '  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- ',
[0]       keywords: [],
[0]       minRating: 0,
[0]       requireOpenNow: true
[0]     },
[0]     requirements: []
[0]   }
[0] ]
[0] Parsed time "08:00" to normalized time "08:00" and Europe/London time: 8:00 AM (2025-06-02 08:00:00 GMT+1)
[0] [SERVICE DEBUG _processGeneralActivities] Called with 1 activities.
[0] Processing 1 general activities (no fixed times)
[0] Processing general activity: I have a lunch in Mayfair 12 -- would like a place with nice fish. 
[0]   Afterwards I would like to work at a nearby coffee shop. Before going to 
[0]   Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- 
[0] Search options for general activity at "51.5074,-0.1278": {
[0]   type: 'pub',
[0]   keywords: [],
[0]   searchTerm: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. \n' +
[0]     '  Afterwards I would like to work at a nearby coffee shop. Before going to \n' +
[0]     '  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- ',
[0]   minRating: 0,
[0]   requireOpenNow: true,
[0]   citySlug: 'london'
[0] }
[0] 🔍 [enhancedPlaceSearch] Starting enhanced search with options: {
[0]   query: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. \n' +
[0]     '  Afterwards I would like to work at a nearby coffee shop. Before going to \n' +
[0]     '  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- ',
[0]   location: '51.5074,-0.1278',
[0]   keywords: [],
[0]   type: 'pub',
[0]   preferences: {
[0]     type: 'pub',
[0]     searchTerm: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. \n' +
[0]       '  Afterwards I would like to work at a nearby coffee shop. Before going to \n' +
[0]       '  Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- ',
[0]     keywords: [],
[0]     minRating: 0,
[0]     requireOpenNow: true
[0]   },
[0]   cityContext: { name: 'London', slug: 'london', timezone: 'Europe/London' }
[0] }
[0] 🏙️ [Area Intelligence] Recommending Fitzrovia for pub (score: 40)
[0]    Reasons: Known for pub, Nearby
[0] 🤖 [Gemini] Enhanced query: "best pubs in Fitzrovia"
[0] 📍 [enhancedPlaceSearch] Using city center for "london"
[0] 🎯 [enhancedPlaceSearch] Using location bias: 51.5074,-0.1278 with radius 25000m
[0] 🌐 [enhancedPlaceSearch] Searching with query: "best pubs in Fitzrovia"
[0] 🏙️ [enhancedPlaceSearch] After city filtering: 4 venues remain for London
[0] ✅ [enhancedPlaceSearch] Found 4 places with ratings
[0] 🎲 [enhancedPlaceSearch] Selected venue (with variety): {
[0]   name: 'The George',
[0]   rating: 4.5,
[0]   address: '55 Great Portland St, London W1W 7LQ, United Kingdom'
[0] }
[0] 🔄 [enhancedPlaceSearch] Alternatives: [
[0]   { name: 'The Black Horse - Pub & Cocktail Bar', rating: 4.7 },
[0]   { name: 'Lore of the Land', rating: 4.6 },
[0]   { name: 'The Court', rating: 4.6 }
[0] ]
[0] Found place for general activity: The George
[0] Added general activity to itinerary: The George at 2025-06-02T17:00:00.000Z
[0] DbStorage (with logging): Creating itinerary (anonymous)
[0] DbStorage (with logging): Error creating itinerary: NeonDbError: column "title" of relation "itineraries" does not exist
[0]     at execute (file:///Users/carlos/LondonDayPlanner-1/node_modules/@neondatabase/serverless/index.mjs:1556:55)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at NeonHttpPreparedQuery.execute (/Users/carlos/LondonDayPlanner-1/node_modules/src/neon-http/session.ts:68:18)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:100:27)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:512:22)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:300:32)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25) {
[0]   severity: 'ERROR',
[0]   code: '42703',
[0]   detail: undefined,
[0]   hint: undefined,
[0]   position: '34',
[0]   internalPosition: undefined,
[0]   internalQuery: undefined,
[0]   where: undefined,
[0]   schema: undefined,
[0]   table: undefined,
[0]   column: undefined,
[0]   dataType: undefined,
[0]   constraint: undefined,
[0]   file: 'parse_target.c',
[0]   line: '1066',
[0]   routine: 'checkInsertTargets',
[0]   sourceError: undefined
[0] }
[0] Using in-memory fallback for createItinerary due to database error
[0] Successfully created itinerary "I have a lunch in Mayfair 12 -- would like a place with nice fish. 
[0]   Afterwards I would like to work at a nearby coffee shop. Before going to 
[0]   Chelsea at 7PM to meet some friends for drinks at a cocktail bar --  in London" for London with ID: 2
[0] [Weather] Fetching weather for 51.52,-0.14
[0] [Weather] Success with OpenWeatherMap
[0] 🌤️ [/:city/plan] Retrieved weather data for itinerary
[0] 🕒 [/:city/plan] Place scheduledTime: 2025-06-02T17:00:00.000Z
[0] 🌍 [/:city/plan] Using timezone: Europe/London
[0] 🕒 [/:city/plan] Formatted time: 6:00 PM
[0] 📤 [/:city/plan] Sending response with 1 venues
[0] POST /api/london/plan 200 17444ms
[0] 📝 [/:city/plan] City-specific plan request for: London
[0] Query: I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?
[0] 🚀 [/:city/plan] Creating city-aware plan for London
[0] 🏙️ Creating plan for city: london
[0] 🚀 Creating plan for query: I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?
[0] [NLP] Processing query with context for city: London
[0] Attempting to process query with new Gemini processor
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:30",
[0]       "endTime": "18:00",
[0]       "activity": "work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "bufferAfter": 0,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {},
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[{"activity":"drinks with friends","bufferAfter":0,"bufferBefore":15,"duration":120,"isFixed":true,"location":"Chelsea","time":"19:00"}],"fixedTimeEntries":[{"activity":"lunch","location":"Mayfair","searchParameters":{"cuisine":"Seafood","venueType":"restaurant"},"time":"12:00","venuePreference":"restaurant with nice fish","venueRequirements":[]}],"flexibleTimeEntries":[],"preferences":{},"specialRequests":[],"timeBlocks":[{"activity":"work","endTime":"18:00","location":"Mayfair","searchParameters":{"venueType":"cafe"},"startTime":"13:30","venueRequirements":[]}],"travelGroup":{}},"processingTimeMs":3883,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?\n    ","temperature":0.2},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:30\",\n      \"endTime\": \"18:00\",\n      \"activity\": \"work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\"\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"bufferAfter\": 0,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": \"Seafood\"\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {},\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"fc85692e-8fb0-4710-b7d6-53294ed60307","status":"success","timestamp":"2025-06-02T23:57:55.027Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?"}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:30",
[0]       "endTime": "18:00",
[0]       "activity": "work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "bufferAfter": 0,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {},
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":6611,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?\n    ","temperature":0.2},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:30\",\n      \"endTime\": \"18:00\",\n      \"activity\": \"work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\"\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"bufferAfter\": 0,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": \"Seafood\"\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {},\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"fc85692e-8fb0-4710-b7d6-53294ed60307","status":"error","timestamp":"2025-06-02T23:57:57.755Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?"}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":6866,"rawRequest":{"temperature":0.2},"service":"ai-interaction-logger","sessionId":"fc85692e-8fb0-4710-b7d6-53294ed60307","status":"error","timestamp":"2025-06-02T23:57:58.010Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?"}
[0] Gemini processing attempt failed at temperature 0.2: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:30",
[0]       "endTime": "18:00",
[0]       "activity": "work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "bufferAfter": 0,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {},
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[{"activity":"drinks with friends","bufferAfter":0,"bufferBefore":15,"duration":120,"isFixed":true,"location":"Chelsea","time":"19:00"}],"fixedTimeEntries":[{"activity":"lunch","location":"Mayfair","searchParameters":{"cuisine":"Seafood","venueType":"restaurant"},"time":"12:00","venuePreference":"restaurant with nice fish","venueRequirements":[]}],"flexibleTimeEntries":[],"preferences":{},"specialRequests":[],"timeBlocks":[{"activity":"work","endTime":"18:00","location":"Mayfair","searchParameters":{"venueType":"cafe"},"startTime":"13:30","venueRequirements":[]}],"travelGroup":{}},"processingTimeMs":3862,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?\n    ","temperature":0.4},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:30\",\n      \"endTime\": \"18:00\",\n      \"activity\": \"work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\"\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"bufferAfter\": 0,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": \"Seafood\"\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {},\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"fc85692e-8fb0-4710-b7d6-53294ed60307","status":"success","timestamp":"2025-06-02T23:58:01.954Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?"}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:30",
[0]       "endTime": "18:00",
[0]       "activity": "work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "bufferAfter": 0,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {},
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":3948,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?\n    ","temperature":0.4},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:30\",\n      \"endTime\": \"18:00\",\n      \"activity\": \"work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\"\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"bufferAfter\": 0,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": \"Seafood\"\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {},\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"fc85692e-8fb0-4710-b7d6-53294ed60307","status":"error","timestamp":"2025-06-02T23:58:02.040Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?"}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4039,"rawRequest":{"temperature":0.4},"service":"ai-interaction-logger","sessionId":"fc85692e-8fb0-4710-b7d6-53294ed60307","status":"error","timestamp":"2025-06-02T23:58:02.131Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?"}
[0] Gemini processing attempt failed at temperature 0.4: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:30",
[0]       "endTime": "18:00",
[0]       "activity": "Work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "Drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "bufferAfter": 0,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "Lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "pace": "moderate"
[0]   },
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[{"activity":"Drinks with friends","bufferAfter":0,"bufferBefore":15,"duration":120,"isFixed":true,"location":"Chelsea","time":"19:00"}],"fixedTimeEntries":[{"activity":"Lunch","location":"Mayfair","searchParameters":{"cuisine":"Seafood","venueType":"restaurant"},"time":"12:00","venuePreference":"restaurant with nice fish","venueRequirements":[]}],"flexibleTimeEntries":[],"preferences":{"pace":"moderate"},"specialRequests":[],"timeBlocks":[{"activity":"Work","endTime":"18:00","location":"Mayfair","searchParameters":{"venueType":"cafe"},"startTime":"13:30","venueRequirements":[]}],"travelGroup":{}},"processingTimeMs":4030,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?\n    ","temperature":0.7},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:30\",\n      \"endTime\": \"18:00\",\n      \"activity\": \"Work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\"\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"Drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"bufferAfter\": 0,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"Lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": \"Seafood\"\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"pace\": \"moderate\"\n  },\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```\n","service":"ai-interaction-logger","sessionId":"fc85692e-8fb0-4710-b7d6-53294ed60307","status":"success","timestamp":"2025-06-02T23:58:06.256Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?"}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [
[0]     {
[0]       "startTime": "13:30",
[0]       "endTime": "18:00",
[0]       "activity": "Work",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     }
[0]   ],
[0]   "fixedAppointments": [
[0]     {
[0]       "time": "19:00",
[0]       "duration": 120,
[0]       "activity": "Drinks with friends",
[0]       "location": "Chelsea",
[0]       "bufferBefore": 15,
[0]       "bufferAfter": 0,
[0]       "isFixed": true
[0]     }
[0]   ],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "Lunch",
[0]       "location": "Mayfair",
[0]       "venuePreference": "restaurant with nice fish",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "cuisine": "Seafood",
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "pace": "moderate"
[0]   },
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4117,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?\n    ","temperature":0.7},"rawResponse":"```json\n{\n  \"timeBlocks\": [\n    {\n      \"startTime\": \"13:30\",\n      \"endTime\": \"18:00\",\n      \"activity\": \"Work\",\n      \"location\": \"Mayfair\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\"\n      }\n    }\n  ],\n  \"fixedAppointments\": [\n    {\n      \"time\": \"19:00\",\n      \"duration\": 120,\n      \"activity\": \"Drinks with friends\",\n      \"location\": \"Chelsea\",\n      \"bufferBefore\": 15,\n      \"bufferAfter\": 0,\n      \"isFixed\": true\n    }\n  ],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"Lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": \"restaurant with nice fish\",\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": \"Seafood\"\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"pace\": \"moderate\"\n  },\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```\n","service":"ai-interaction-logger","sessionId":"fc85692e-8fb0-4710-b7d6-53294ed60307","status":"error","timestamp":"2025-06-02T23:58:06.343Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?"}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":6394,"rawRequest":{"temperature":0.7},"service":"ai-interaction-logger","sessionId":"fc85692e-8fb0-4710-b7d6-53294ed60307","status":"error","timestamp":"2025-06-02T23:58:08.620Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?"}
[0] Gemini processing attempt failed at temperature 0.7: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] [32minfo[39m: AI Interaction {"errorDetails":"Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","service":"ai-interaction-logger","sessionId":"fc85692e-8fb0-4710-b7d6-53294ed60307","status":"error","timestamp":"2025-06-02T23:58:08.701Z","userQuery":"I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?"}
[0] New Gemini processor unavailable or failed, falling back to original method
[0] Converting Gemini result to app format: null
[0] 📝 Parsed request from cache/fetch: {
[0]   startLocation: '51.5074,-0.1278',
[0]   destinations: [],
[0]   fixedTimes: [],
[0]   preferences: { type: undefined, requirements: [] }
[0] }
[0] 📍 Using explicit start location from NLP: 51.5074,-0.1278
[0] 📍 Determined initial search/start location: 51.5074,-0.1278
[0] 🔧 NLP returned empty fixedTimes and activities, creating fallback activity based on original query.
[0] 🔧 Fallback activity created: [
[0]   {
[0]     description: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?',
[0]     location: '51.5074,-0.1278',
[0]     time: '12:00',
[0]     searchParameters: {
[0]       type: 'pub',
[0]       searchTerm: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?',
[0]       keywords: [],
[0]       minRating: 0,
[0]       requireOpenNow: true
[0]     },
[0]     requirements: []
[0]   }
[0] ]
[0] Parsed time "12:00" to normalized time "12:00" and Europe/London time: 12:00 PM (2025-06-01 12:00:00 GMT+1)
[0] [SERVICE DEBUG _processGeneralActivities] Called with 1 activities.
[0] Processing 1 general activities (no fixed times)
[0] Processing general activity: I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?
[0] Search options for general activity at "51.5074,-0.1278": {
[0]   type: 'pub',
[0]   keywords: [],
[0]   searchTerm: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?',
[0]   minRating: 0,
[0]   requireOpenNow: true,
[0]   citySlug: 'london'
[0] }
[0] 🔍 [enhancedPlaceSearch] Starting enhanced search with options: {
[0]   query: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?',
[0]   location: '51.5074,-0.1278',
[0]   keywords: [],
[0]   type: 'pub',
[0]   preferences: {
[0]     type: 'pub',
[0]     searchTerm: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?',
[0]     keywords: [],
[0]     minRating: 0,
[0]     requireOpenNow: true
[0]   },
[0]   cityContext: { name: 'London', slug: 'london', timezone: 'Europe/London' }
[0] }
[0] 🏙️ [Area Intelligence] Recommending Fitzrovia for pub (score: 40)
[0]    Reasons: Known for pub, Nearby
[0] 🤖 [Gemini] Enhanced query: "best pubs in Fitzrovia cocktails"
[0] 📍 [enhancedPlaceSearch] Using city center for "london"
[0] 🎯 [enhancedPlaceSearch] Using location bias: 51.5074,-0.1278 with radius 25000m
[0] 🌐 [enhancedPlaceSearch] Searching with query: "best pubs in Fitzrovia cocktails"
[0] 🏙️ [enhancedPlaceSearch] After city filtering: 4 venues remain for London
[0] ✅ [enhancedPlaceSearch] Found 4 places with ratings
[0] 🎲 [enhancedPlaceSearch] Selected venue (with variety): {
[0]   name: 'Murder Inc. Cocktails',
[0]   rating: 4.9,
[0]   address: '36 Hanway St, London W1T 1UP, United Kingdom'
[0] }
[0] 🔄 [enhancedPlaceSearch] Alternatives: [
[0]   { name: 'The Royal Cocktail Exchange', rating: 4.9 },
[0]   { name: 'The Black Horse - Pub & Cocktail Bar', rating: 4.7 },
[0]   {
[0]     name: 'The Cocktail Club - Cocktail Bar in Fitzrovia',
[0]     rating: 4.5
[0]   }
[0] ]
[0] Found place for general activity: Murder Inc. Cocktails
[0] Added general activity to itinerary: Murder Inc. Cocktails at 2025-06-01T17:00:00.000Z
[0] DbStorage (with logging): Creating itinerary (anonymous)
[0] DbStorage (with logging): Error creating itinerary: NeonDbError: column "title" of relation "itineraries" does not exist
[0]     at execute (file:///Users/carlos/LondonDayPlanner-1/node_modules/@neondatabase/serverless/index.mjs:1556:55)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at NeonHttpPreparedQuery.execute (/Users/carlos/LondonDayPlanner-1/node_modules/src/neon-http/session.ts:68:18)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:100:27)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:512:22)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:300:32)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25) {
[0]   severity: 'ERROR',
[0]   code: '42703',
[0]   detail: undefined,
[0]   hint: undefined,
[0]   position: '34',
[0]   internalPosition: undefined,
[0]   internalQuery: undefined,
[0]   where: undefined,
[0]   schema: undefined,
[0]   table: undefined,
[0]   column: undefined,
[0]   dataType: undefined,
[0]   constraint: undefined,
[0]   file: 'parse_target.c',
[0]   line: '1066',
[0]   routine: 'checkInsertTargets',
[0]   sourceError: undefined
[0] }
[0] Using in-memory fallback for createItinerary due to database error
[0] Successfully created itinerary "I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one? in London" for London with ID: 3
[0] [Weather] Using cached data for 51.52,-0.13
[0] 🌤️ [/:city/plan] Retrieved weather data for itinerary
[0] 🕒 [/:city/plan] Place scheduledTime: 2025-06-01T17:00:00.000Z
[0] 🌍 [/:city/plan] Using timezone: Europe/London
[0] 🕒 [/:city/plan] Formatted time: 6:00 PM
[0] 📤 [/:city/plan] Sending response with 1 venues
[0] POST /api/london/plan 200 20303ms
[0] 📝 [/:city/plan] City-specific plan request for: London
[0] Query: I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?
[0] 🚀 [/:city/plan] Creating city-aware plan for London
[0] 🏙️ Creating plan for city: london
[0] 🚀 Creating plan for query: I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?
[0] 📝 Parsed request from cache/fetch: {
[0]   startLocation: '51.5074,-0.1278',
[0]   destinations: [],
[0]   fixedTimes: [],
[0]   preferences: { type: undefined, requirements: [] },
[0]   activities: [
[0]     {
[0]       description: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?',
[0]       location: '51.5074,-0.1278',
[0]       time: '12:00',
[0]       searchParameters: [Object],
[0]       requirements: []
[0]     }
[0]   ]
[0] }
[0] 📍 Using explicit start location from NLP: 51.5074,-0.1278
[0] 📍 Determined initial search/start location: 51.5074,-0.1278
[0] Parsed time "12:00" to normalized time "12:00" and Europe/London time: 12:00 PM (2025-06-01 12:00:00 GMT+1)
[0] [SERVICE DEBUG _processGeneralActivities] Called with 1 activities.
[0] Processing 1 general activities (no fixed times)
[0] Processing general activity: I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?
[0] Search options for general activity at "51.5074,-0.1278": {
[0]   type: 'pub',
[0]   keywords: [],
[0]   searchTerm: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?',
[0]   minRating: 0,
[0]   requireOpenNow: true,
[0]   citySlug: 'london'
[0] }
[0] Found place for general activity: Murder Inc. Cocktails
[0] Place "Murder Inc. Cocktails" already exists, returning existing record
[0] Added general activity to itinerary: Murder Inc. Cocktails at 2025-06-01T17:00:00.000Z
[0] DbStorage (with logging): Creating itinerary (anonymous)
[0] DbStorage (with logging): Error creating itinerary: NeonDbError: column "title" of relation "itineraries" does not exist
[0]     at execute (file:///Users/carlos/LondonDayPlanner-1/node_modules/@neondatabase/serverless/index.mjs:1556:55)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at NeonHttpPreparedQuery.execute (/Users/carlos/LondonDayPlanner-1/node_modules/src/neon-http/session.ts:68:18)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:100:27)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:512:22)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:300:32)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25) {
[0]   severity: 'ERROR',
[0]   code: '42703',
[0]   detail: undefined,
[0]   hint: undefined,
[0]   position: '34',
[0]   internalPosition: undefined,
[0]   internalQuery: undefined,
[0]   where: undefined,
[0]   schema: undefined,
[0]   table: undefined,
[0]   column: undefined,
[0]   dataType: undefined,
[0]   constraint: undefined,
[0]   file: 'parse_target.c',
[0]   line: '1066',
[0]   routine: 'checkInsertTargets',
[0]   sourceError: undefined
[0] }
[0] Using in-memory fallback for createItinerary due to database error
[0] Successfully created itinerary "I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one? in London" for London with ID: 4
[0] [Weather] Using cached data for 51.52,-0.13
[0] 🌤️ [/:city/plan] Retrieved weather data for itinerary
[0] 🕒 [/:city/plan] Place scheduledTime: 2025-06-01T17:00:00.000Z
[0] 🌍 [/:city/plan] Using timezone: Europe/London
[0] 🕒 [/:city/plan] Formatted time: 6:00 PM
[0] 📤 [/:city/plan] Sending response with 1 venues
[0] POST /api/london/plan 200 3049ms
[0] 📝 [/:city/plan] City-specific plan request for: London
[0] Query: Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea
[0] 🚀 [/:city/plan] Creating city-aware plan for London
[0] 🏙️ Creating plan for city: london
[0] 🚀 Creating plan for query: Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea
[0] [NLP] Processing query with context for city: London
[0] Attempting to process query with new Gemini processor
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [
[0]     {
[0]       "time": "13:30",
[0]       "activity": "coffee",
[0]       "location": "Central London",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     },
[0]     {
[0]       "time": "15:00",
[0]       "activity": "drinks",
[0]       "location": "Chelsea",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 0,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[],"fixedTimeEntries":[{"activity":"lunch","location":"Mayfair","searchParameters":{"venueType":"restaurant"},"time":"12:00","venueRequirements":[]}],"flexibleTimeEntries":[{"activity":"coffee","location":"Central London","searchParameters":{"specificRequirements":[],"venueType":"cafe"},"time":"13:30","venueRequirements":[]},{"activity":"drinks","location":"Chelsea","searchParameters":{"specificRequirements":[],"venueType":"bar"},"time":"15:00","venueRequirements":[]}],"preferences":{"budget":"moderate","interests":[]},"specialRequests":[],"timeBlocks":[],"travelGroup":{"adults":0,"children":0}},"processingTimeMs":4498,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea\n    ","temperature":0.2},"rawResponse":"```json\n{\n  \"timeBlocks\": [],\n  \"fixedAppointments\": [],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": null,\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [\n    {\n      \"time\": \"13:30\",\n      \"activity\": \"coffee\",\n      \"location\": \"Central London\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    },\n    {\n      \"time\": \"15:00\",\n      \"activity\": \"drinks\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": null,\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 0,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"491fa548-660f-44d6-b9b3-0225dbc3ecdc","status":"success","timestamp":"2025-06-03T00:02:09.400Z","userQuery":"Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [
[0]     {
[0]       "time": "13:30",
[0]       "activity": "coffee",
[0]       "location": "Central London",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     },
[0]     {
[0]       "time": "15:00",
[0]       "activity": "drinks",
[0]       "location": "Chelsea",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 0,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4848,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea\n    ","temperature":0.2},"rawResponse":"```json\n{\n  \"timeBlocks\": [],\n  \"fixedAppointments\": [],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": null,\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [\n    {\n      \"time\": \"13:30\",\n      \"activity\": \"coffee\",\n      \"location\": \"Central London\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    },\n    {\n      \"time\": \"15:00\",\n      \"activity\": \"drinks\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": null,\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 0,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"491fa548-660f-44d6-b9b3-0225dbc3ecdc","status":"error","timestamp":"2025-06-03T00:02:09.750Z","userQuery":"Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":5127,"rawRequest":{"temperature":0.2},"service":"ai-interaction-logger","sessionId":"491fa548-660f-44d6-b9b3-0225dbc3ecdc","status":"error","timestamp":"2025-06-03T00:02:10.029Z","userQuery":"Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] Gemini processing attempt failed at temperature 0.2: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [
[0]     {
[0]       "time": "13:30",
[0]       "activity": "coffee",
[0]       "location": "Central London",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     },
[0]     {
[0]       "time": "15:00",
[0]       "activity": "drinks",
[0]       "location": "Chelsea",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 0,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[],"fixedTimeEntries":[{"activity":"lunch","location":"Mayfair","searchParameters":{"venueType":"restaurant"},"time":"12:00","venueRequirements":[]}],"flexibleTimeEntries":[{"activity":"coffee","location":"Central London","searchParameters":{"specificRequirements":[],"venueType":"cafe"},"time":"13:30","venueRequirements":[]},{"activity":"drinks","location":"Chelsea","searchParameters":{"specificRequirements":[],"venueType":"bar"},"time":"15:00","venueRequirements":[]}],"preferences":{"budget":"moderate","interests":[]},"specialRequests":[],"timeBlocks":[],"travelGroup":{"adults":0,"children":0}},"processingTimeMs":4397,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea\n    ","temperature":0.4},"rawResponse":"```json\n{\n  \"timeBlocks\": [],\n  \"fixedAppointments\": [],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": null,\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [\n    {\n      \"time\": \"13:30\",\n      \"activity\": \"coffee\",\n      \"location\": \"Central London\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    },\n    {\n      \"time\": \"15:00\",\n      \"activity\": \"drinks\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": null,\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 0,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"491fa548-660f-44d6-b9b3-0225dbc3ecdc","status":"success","timestamp":"2025-06-03T00:02:14.515Z","userQuery":"Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [
[0]     {
[0]       "time": "13:30",
[0]       "activity": "coffee",
[0]       "location": "Central London",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     },
[0]     {
[0]       "time": "15:00",
[0]       "activity": "drinks",
[0]       "location": "Chelsea",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 0,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4483,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea\n    ","temperature":0.4},"rawResponse":"```json\n{\n  \"timeBlocks\": [],\n  \"fixedAppointments\": [],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": null,\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [\n    {\n      \"time\": \"13:30\",\n      \"activity\": \"coffee\",\n      \"location\": \"Central London\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    },\n    {\n      \"time\": \"15:00\",\n      \"activity\": \"drinks\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": null,\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 0,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"491fa548-660f-44d6-b9b3-0225dbc3ecdc","status":"error","timestamp":"2025-06-03T00:02:14.601Z","userQuery":"Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4575,"rawRequest":{"temperature":0.4},"service":"ai-interaction-logger","sessionId":"491fa548-660f-44d6-b9b3-0225dbc3ecdc","status":"error","timestamp":"2025-06-03T00:02:14.693Z","userQuery":"Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] Gemini processing attempt failed at temperature 0.4: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [
[0]     {
[0]       "time": "13:30",
[0]       "activity": "coffee",
[0]       "location": "Central London",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     },
[0]     {
[0]       "time": "15:00",
[0]       "activity": "drinks",
[0]       "location": "Chelsea",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "pace": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 1,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[],"fixedTimeEntries":[{"activity":"lunch","location":"Mayfair","searchParameters":{"venueType":"restaurant"},"time":"12:00","venueRequirements":[]}],"flexibleTimeEntries":[{"activity":"coffee","location":"Central London","searchParameters":{"specificRequirements":[],"venueType":"cafe"},"time":"13:30","venueRequirements":[]},{"activity":"drinks","location":"Chelsea","searchParameters":{"specificRequirements":[],"venueType":"bar"},"time":"15:00","venueRequirements":[]}],"preferences":{"budget":"moderate","interests":[],"pace":"moderate"},"specialRequests":[],"timeBlocks":[],"travelGroup":{"adults":1,"children":0}},"processingTimeMs":4381,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea\n    ","temperature":0.7},"rawResponse":"```json\n{\n  \"timeBlocks\": [],\n  \"fixedAppointments\": [],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": null,\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [\n    {\n      \"time\": \"13:30\",\n      \"activity\": \"coffee\",\n      \"location\": \"Central London\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    },\n    {\n      \"time\": \"15:00\",\n      \"activity\": \"drinks\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": \"moderate\",\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 1,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```\n","service":"ai-interaction-logger","sessionId":"491fa548-660f-44d6-b9b3-0225dbc3ecdc","status":"success","timestamp":"2025-06-03T00:02:19.160Z","userQuery":"Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "restaurant"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [
[0]     {
[0]       "time": "13:30",
[0]       "activity": "coffee",
[0]       "location": "Central London",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     },
[0]     {
[0]       "time": "15:00",
[0]       "activity": "drinks",
[0]       "location": "Chelsea",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "pace": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 1,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4636,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea\n    ","temperature":0.7},"rawResponse":"```json\n{\n  \"timeBlocks\": [],\n  \"fixedAppointments\": [],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": null,\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [\n    {\n      \"time\": \"13:30\",\n      \"activity\": \"coffee\",\n      \"location\": \"Central London\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    },\n    {\n      \"time\": \"15:00\",\n      \"activity\": \"drinks\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": \"moderate\",\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 1,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```\n","service":"ai-interaction-logger","sessionId":"491fa548-660f-44d6-b9b3-0225dbc3ecdc","status":"error","timestamp":"2025-06-03T00:02:19.415Z","userQuery":"Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4895,"rawRequest":{"temperature":0.7},"service":"ai-interaction-logger","sessionId":"491fa548-660f-44d6-b9b3-0225dbc3ecdc","status":"error","timestamp":"2025-06-03T00:02:19.674Z","userQuery":"Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] Gemini processing attempt failed at temperature 0.7: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] [32minfo[39m: AI Interaction {"errorDetails":"Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","service":"ai-interaction-logger","sessionId":"491fa548-660f-44d6-b9b3-0225dbc3ecdc","status":"error","timestamp":"2025-06-03T00:02:19.760Z","userQuery":"Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] New Gemini processor unavailable or failed, falling back to original method
[0] Converting Gemini result to app format: null
[0] 📝 Parsed request from cache/fetch: {
[0]   startLocation: '51.5074,-0.1278',
[0]   destinations: [ 'Chelsea' ],
[0]   fixedTimes: [],
[0]   preferences: { type: undefined, requirements: [] }
[0] }
[0] 📍 Using explicit start location from NLP: 51.5074,-0.1278
[0] 📍 Determined initial search/start location: 51.5074,-0.1278
[0] 🔧 NLP returned empty fixedTimes and activities, creating fallback activity based on original query.
[0] 🔧 Fallback activity created: [
[0]   {
[0]     description: 'Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea',
[0]     location: '51.5074,-0.1278',
[0]     time: '12:00',
[0]     searchParameters: {
[0]       type: 'pub',
[0]       searchTerm: 'Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea',
[0]       keywords: [],
[0]       minRating: 0,
[0]       requireOpenNow: true
[0]     },
[0]     requirements: []
[0]   }
[0] ]
[0] Parsed time "12:00" to normalized time "12:00" and Europe/London time: 12:00 PM (2025-06-01 12:00:00 GMT+1)
[0] [SERVICE DEBUG _processGeneralActivities] Called with 1 activities.
[0] Processing 1 general activities (no fixed times)
[0] Processing general activity: Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea
[0] Search options for general activity at "51.5074,-0.1278": {
[0]   type: 'pub',
[0]   keywords: [],
[0]   searchTerm: 'Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea',
[0]   minRating: 0,
[0]   requireOpenNow: true,
[0]   citySlug: 'london'
[0] }
[0] 🔍 [enhancedPlaceSearch] Starting enhanced search with options: {
[0]   query: 'Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea',
[0]   location: '51.5074,-0.1278',
[0]   keywords: [],
[0]   type: 'pub',
[0]   preferences: {
[0]     type: 'pub',
[0]     searchTerm: 'Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea',
[0]     keywords: [],
[0]     minRating: 0,
[0]     requireOpenNow: true
[0]   },
[0]   cityContext: { name: 'London', slug: 'london', timezone: 'Europe/London' }
[0] }
[0] 🏙️ [Area Intelligence] Recommending Fitzrovia for pub (score: 40)
[0]    Reasons: Known for pub, Nearby
[0] 🤖 [Gemini] Enhanced query: "best pubs in Fitzrovia"
[0] 📍 [enhancedPlaceSearch] Using city center for "london"
[0] 🎯 [enhancedPlaceSearch] Using location bias: 51.5074,-0.1278 with radius 25000m
[0] 🌐 [enhancedPlaceSearch] Searching with query: "best pubs in Fitzrovia"
[0] 🏙️ [enhancedPlaceSearch] After city filtering: 4 venues remain for London
[0] ✅ [enhancedPlaceSearch] Found 4 places with ratings
[0] 🎲 [enhancedPlaceSearch] Selected venue (with variety): {
[0]   name: 'Lore of the Land',
[0]   rating: 4.6,
[0]   address: '4 Conway St, London W1T 6BB, United Kingdom'
[0] }
[0] 🔄 [enhancedPlaceSearch] Alternatives: [
[0]   { name: 'The Black Horse - Pub & Cocktail Bar', rating: 4.7 },
[0]   { name: 'The Court', rating: 4.6 },
[0]   { name: 'The George', rating: 4.5 }
[0] ]
[0] Found place for general activity: Lore of the Land
[0] Added general activity to itinerary: Lore of the Land at 2025-06-01T17:00:00.000Z
[0] DbStorage (with logging): Creating itinerary (anonymous)
[0] DbStorage (with logging): Error creating itinerary: NeonDbError: column "title" of relation "itineraries" does not exist
[0]     at execute (file:///Users/carlos/LondonDayPlanner-1/node_modules/@neondatabase/serverless/index.mjs:1556:55)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at NeonHttpPreparedQuery.execute (/Users/carlos/LondonDayPlanner-1/node_modules/src/neon-http/session.ts:68:18)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:100:27)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:512:22)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:300:32)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25) {
[0]   severity: 'ERROR',
[0]   code: '42703',
[0]   detail: undefined,
[0]   hint: undefined,
[0]   position: '34',
[0]   internalPosition: undefined,
[0]   internalQuery: undefined,
[0]   where: undefined,
[0]   schema: undefined,
[0]   table: undefined,
[0]   column: undefined,
[0]   dataType: undefined,
[0]   constraint: undefined,
[0]   file: 'parse_target.c',
[0]   line: '1066',
[0]   routine: 'checkInsertTargets',
[0]   sourceError: undefined
[0] }
[0] Using in-memory fallback for createItinerary due to database error
[0] Successfully created itinerary "Test multi-step: lunch in Mayfair, then coffee, then drinks in Chelsea in London" for London with ID: 5
[0] [Weather] Using cached data for 51.52,-0.14
[0] 🌤️ [/:city/plan] Retrieved weather data for itinerary
[0] 🕒 [/:city/plan] Place scheduledTime: 2025-06-01T17:00:00.000Z
[0] 🌍 [/:city/plan] Using timezone: Europe/London
[0] 🕒 [/:city/plan] Formatted time: 6:00 PM
[0] 📤 [/:city/plan] Sending response with 1 venues
[0] POST /api/london/plan 200 17411ms
[0] 📝 [/:city/plan] City-specific plan request for: London
[0] Query: Lunch in Mayfair, then coffee, then drinks in Chelsea
[0] 🚀 [/:city/plan] Creating city-aware plan for London
[0] 🏙️ Creating plan for city: london
[0] 🚀 Creating plan for query: Lunch in Mayfair, then coffee, then drinks in Chelsea
[0] [NLP] Processing query with context for city: London
[0] Attempting to process query with new Gemini processor
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "restaurant"
[0]       }
[0]     },
[0]     {
[0]       "time": "13:30",
[0]       "activity": "coffee",
[0]       "location": "Central London",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     },
[0]     {
[0]       "time": "15:00",
[0]       "activity": "drinks",
[0]       "location": "Chelsea",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "pace": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[],"fixedTimeEntries":[{"activity":"lunch","location":"Mayfair","searchParameters":{"venueType":"restaurant"},"time":"12:00","venueRequirements":[]},{"activity":"coffee","location":"Central London","searchParameters":{"venueType":"cafe"},"time":"13:30","venueRequirements":[]},{"activity":"drinks","location":"Chelsea","searchParameters":{"venueType":"bar"},"time":"15:00","venueRequirements":[]}],"flexibleTimeEntries":[],"preferences":{"budget":"moderate","interests":[],"pace":"moderate"},"specialRequests":[],"timeBlocks":[],"travelGroup":{}},"processingTimeMs":4170,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    Lunch in Mayfair, then coffee, then drinks in Chelsea\n    ","temperature":0.2},"rawResponse":"```json\n{\n  \"timeBlocks\": [],\n  \"fixedAppointments\": [],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": null,\n        \"priceLevel\": null\n      }\n    },\n    {\n      \"time\": \"13:30\",\n      \"activity\": \"coffee\",\n      \"location\": \"Central London\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"priceLevel\": null\n      }\n    },\n    {\n      \"time\": \"15:00\",\n      \"activity\": \"drinks\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": \"moderate\",\n    \"interests\": []\n  },\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```\n","service":"ai-interaction-logger","sessionId":"a969ed26-ebaf-45ad-a8b1-50b3987e477d","status":"success","timestamp":"2025-06-03T00:03:28.304Z","userQuery":"Lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "restaurant"
[0]       }
[0]     },
[0]     {
[0]       "time": "13:30",
[0]       "activity": "coffee",
[0]       "location": "Central London",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     },
[0]     {
[0]       "time": "15:00",
[0]       "activity": "drinks",
[0]       "location": "Chelsea",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "pace": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {},
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4448,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    Lunch in Mayfair, then coffee, then drinks in Chelsea\n    ","temperature":0.2},"rawResponse":"```json\n{\n  \"timeBlocks\": [],\n  \"fixedAppointments\": [],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": null,\n        \"priceLevel\": null\n      }\n    },\n    {\n      \"time\": \"13:30\",\n      \"activity\": \"coffee\",\n      \"location\": \"Central London\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"priceLevel\": null\n      }\n    },\n    {\n      \"time\": \"15:00\",\n      \"activity\": \"drinks\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": \"moderate\",\n    \"interests\": []\n  },\n  \"travelGroup\": {},\n  \"specialRequests\": []\n}\n```\n","service":"ai-interaction-logger","sessionId":"a969ed26-ebaf-45ad-a8b1-50b3987e477d","status":"error","timestamp":"2025-06-03T00:03:28.582Z","userQuery":"Lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4739,"rawRequest":{"temperature":0.2},"service":"ai-interaction-logger","sessionId":"a969ed26-ebaf-45ad-a8b1-50b3987e477d","status":"error","timestamp":"2025-06-03T00:03:28.873Z","userQuery":"Lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] Gemini processing attempt failed at temperature 0.2: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "restaurant"
[0]       }
[0]     },
[0]     {
[0]       "time": "13:30",
[0]       "activity": "coffee",
[0]       "location": "Central London",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     },
[0]     {
[0]       "time": "15:00",
[0]       "activity": "drinks",
[0]       "location": "Chelsea",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "pace": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 1,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[],"fixedTimeEntries":[{"activity":"lunch","location":"Mayfair","searchParameters":{"venueType":"restaurant"},"time":"12:00","venueRequirements":[]},{"activity":"coffee","location":"Central London","searchParameters":{"specificRequirements":[],"venueType":"cafe"},"time":"13:30","venueRequirements":[]},{"activity":"drinks","location":"Chelsea","searchParameters":{"specificRequirements":[],"venueType":"bar"},"time":"15:00","venueRequirements":[]}],"flexibleTimeEntries":[],"preferences":{"budget":"moderate","interests":[],"pace":"moderate"},"specialRequests":[],"timeBlocks":[],"travelGroup":{"adults":1,"children":0}},"processingTimeMs":4338,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    Lunch in Mayfair, then coffee, then drinks in Chelsea\n    ","temperature":0.4},"rawResponse":"```json\n{\n  \"timeBlocks\": [],\n  \"fixedAppointments\": [],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": null,\n        \"priceLevel\": null\n      }\n    },\n    {\n      \"time\": \"13:30\",\n      \"activity\": \"coffee\",\n      \"location\": \"Central London\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    },\n    {\n      \"time\": \"15:00\",\n      \"activity\": \"drinks\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": \"moderate\",\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 1,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"a969ed26-ebaf-45ad-a8b1-50b3987e477d","status":"success","timestamp":"2025-06-03T00:03:33.298Z","userQuery":"Lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "restaurant"
[0]       }
[0]     },
[0]     {
[0]       "time": "13:30",
[0]       "activity": "coffee",
[0]       "location": "Central London",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe",
[0]         "specificRequirements": []
[0]       }
[0]     },
[0]     {
[0]       "time": "15:00",
[0]       "activity": "drinks",
[0]       "location": "Chelsea",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar",
[0]         "specificRequirements": []
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "pace": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 1,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":7066,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    Lunch in Mayfair, then coffee, then drinks in Chelsea\n    ","temperature":0.4},"rawResponse":"```json\n{\n  \"timeBlocks\": [],\n  \"fixedAppointments\": [],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": null,\n        \"priceLevel\": null\n      }\n    },\n    {\n      \"time\": \"13:30\",\n      \"activity\": \"coffee\",\n      \"location\": \"Central London\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    },\n    {\n      \"time\": \"15:00\",\n      \"activity\": \"drinks\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"specificRequirements\": [],\n        \"ambience\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": \"moderate\",\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 1,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"a969ed26-ebaf-45ad-a8b1-50b3987e477d","status":"error","timestamp":"2025-06-03T00:03:36.026Z","userQuery":"Lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":9372,"rawRequest":{"temperature":0.4},"service":"ai-interaction-logger","sessionId":"a969ed26-ebaf-45ad-a8b1-50b3987e477d","status":"error","timestamp":"2025-06-03T00:03:38.332Z","userQuery":"Lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] Gemini processing attempt failed at temperature 0.4: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] Raw Gemini structured data: {
[0]   "timeBlocks": [],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "restaurant"
[0]       }
[0]     },
[0]     {
[0]       "time": "13:30",
[0]       "activity": "coffee",
[0]       "location": "Central London",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     },
[0]     {
[0]       "time": "15:00",
[0]       "activity": "drinks",
[0]       "location": "Chelsea",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "pace": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 1,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"modelName":"gemini-1.5-pro","parsedResponse":{"fixedAppointments":[],"fixedTimeEntries":[{"activity":"lunch","location":"Mayfair","searchParameters":{"venueType":"restaurant"},"time":"12:00","venueRequirements":[]},{"activity":"coffee","location":"Central London","searchParameters":{"venueType":"cafe"},"time":"13:30","venueRequirements":[]},{"activity":"drinks","location":"Chelsea","searchParameters":{"venueType":"bar"},"time":"15:00","venueRequirements":[]}],"flexibleTimeEntries":[],"preferences":{"budget":"moderate","interests":[],"pace":"moderate"},"specialRequests":[],"timeBlocks":[],"travelGroup":{"adults":1,"children":0}},"processingTimeMs":4403,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    Lunch in Mayfair, then coffee, then drinks in Chelsea\n    ","temperature":0.7},"rawResponse":"```json\n{\n  \"timeBlocks\": [],\n  \"fixedAppointments\": [],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": null,\n        \"priceLevel\": null\n      }\n    },\n    {\n      \"time\": \"13:30\",\n      \"activity\": \"coffee\",\n      \"location\": \"Central London\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"priceLevel\": null\n      }\n    },\n    {\n      \"time\": \"15:00\",\n      \"activity\": \"drinks\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": \"moderate\",\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 1,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"a969ed26-ebaf-45ad-a8b1-50b3987e477d","status":"success","timestamp":"2025-06-03T00:03:42.832Z","userQuery":"Lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] Processing Gemini response with raw data: {
[0]   "timeBlocks": [],
[0]   "fixedAppointments": [],
[0]   "fixedTimeEntries": [
[0]     {
[0]       "time": "12:00",
[0]       "activity": "lunch",
[0]       "location": "Mayfair",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "restaurant"
[0]       }
[0]     },
[0]     {
[0]       "time": "13:30",
[0]       "activity": "coffee",
[0]       "location": "Central London",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "cafe"
[0]       }
[0]     },
[0]     {
[0]       "time": "15:00",
[0]       "activity": "drinks",
[0]       "location": "Chelsea",
[0]       "venueRequirements": [],
[0]       "searchParameters": {
[0]         "venueType": "bar"
[0]       }
[0]     }
[0]   ],
[0]   "flexibleTimeEntries": [],
[0]   "preferences": {
[0]     "budget": "moderate",
[0]     "pace": "moderate",
[0]     "interests": []
[0]   },
[0]   "travelGroup": {
[0]     "adults": 1,
[0]     "children": 0
[0]   },
[0]   "specialRequests": []
[0] }
[0] [32minfo[39m: AI Interaction {"errorDetails":"JSON parsing error: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4501,"rawRequest":{"prompt":"\n    You are an expert travel planning assistant for London. Extract structured information from this itinerary request with extreme attention to detail.\n    \n    CRITICAL PARSING RULES:\n    \n    1. JSON FORMAT: Return ONLY valid JSON matching the schema - no markdown, no extra text\n    \n    2. TIME EXTRACTION:\n       - Use 24-hour format (e.g., \"09:00\", \"15:30\")\n       - \"at 6\" without context = \"18:00\" (assume evening for dinner/drinks)\n       - \"at 6\" with morning context = \"06:00\"\n       - Default meal times: breakfast=\"09:00\", lunch=\"12:00\", dinner=\"19:00\"\n       - \"morning\"=\"09:00\", \"afternoon\"=\"14:00\", \"evening\"=\"18:00\", \"night\"=\"21:00\"\n       - \"early morning\"=\"07:00\", \"late morning\"=\"11:00\", \"late afternoon\"=\"16:00\"\n       - \"sunset\" = \"18:30\", \"sunrise\" = \"06:30\"\n       - RELATIVE TIME HANDLING (CRITICAL):\n         * \"in X hours\" = add X hours to the start time or previous activity time\n         * \"X hours later\" = add X hours to the previous activity time\n         * Example: If start is 10:00, \"in 1 hour\" = \"11:00\", \"in 3 hours\" = \"13:00\"\n         * Example: If last activity is 12:00, \"2 hours later\" = \"14:00\"\n    \n    3. TIME BLOCKS & APPOINTMENTS - NEW CRITICAL PARSING:\n       - TIME BLOCKS: \"work from X to Y\", \"spend X hours at\", \"need X hours for\"\n         * Example: \"work from 10 AM to 3 PM\" → timeBlocks entry with startTime: \"10:00\", endTime: \"15:00\"\n         * Example: \"need a quiet place to work for 5 hours\" → timeBlocks entry with duration reflected in end time\n         * Extract venue requirements: \"quiet\", \"good wifi\", \"suitable for calls\"\n       - FIXED APPOINTMENTS: \"meeting at X\", \"appointment at Y\", \"reservation at Z\"\n         * Example: \"meeting in Mayfair at 5\" → fixedAppointments entry with time: \"17:00\", location: \"Mayfair\"\n         * Add buffers: meeting = 30 min before, dinner = 15 min before\n       - REGULAR ACTIVITIES: Everything else goes in fixedTimeEntries\n    \n    4. ACTIVITY SEQUENCE - CRITICAL:\n       - Preserve the EXACT order mentioned by the user\n       - \"then\", \"after that\", \"after\", \"followed by\", \"next\", \"afterwards\" indicate sequence\n       - Count ALL activities mentioned (coffee, lunch, drinks, etc.)\n       - If no times given, space activities 1.5-2 hours apart\n       - Parse compound sentences carefully: \"I have a meeting... and would like to go to a restaurant\" = 2 activities\n    \n    5. VENUE PREFERENCES - CRITICAL:\n       - ALWAYS extract venue descriptors to venuePreference field\n       - Examples that MUST be captured:\n         * \"hipster cafe\" → venuePreference: \"hipster cafe\"\n         * \"authentic Jewish deli\" → venuePreference: \"authentic Jewish deli\"\n         * \"trendy brunch spot\" → venuePreference: \"trendy brunch spot\"\n         * \"hole-in-the-wall\" → venuePreference: \"hole-in-the-wall\"\n         * \"michelin star\" → venuePreference: \"michelin star restaurant\"\n         * \"rooftop bar\" → venuePreference: \"rooftop bar\"\n         * \"sports bar\" → venuePreference: \"sports bar\"\n         * \"family-friendly\" → venuePreference: \"family-friendly restaurant\"\n         * \"outdoor seating\" → specificRequirements: [\"outdoor seating\"]\n         * \"with a view\" → specificRequirements: [\"with a view\"]\n         * \"good wifi\" → specificRequirements: [\"wifi\"]\n    \n    6. LOCATION INTELLIGENCE - CRITICAL:\n       - PRESERVE ALL LOCATION MENTIONS from the user's query!\n       - Common London locations: \"Shoreditch\", \"Notting Hill\", \"Covent Garden\", \"Camden\"\n       - If user mentions a specific place (e.g., \"Barton Springs\", \"4th st\"), USE IT EXACTLY\n       - Keep landmark names as-is\n       - \"that famous museum\" → Try to infer (British Museum, Tower of London, Hyde Park)\n       - \"nearby\" → Use previous activity's location\n       - \"somewhere nice\" or generic location → \"Central London\"\n       - No location → \"Central London\"\n       - NEVER replace specific location mentions with generic ones\n    \n    6. SPECIAL REQUIREMENTS:\n       - Budget mentions: \"cheap\"/\"budget\" → budget: \"budget\", \"upscale\"/\"fancy\" → budget: \"expensive\"\n       - Group size: \"family\", \"group of X\" → travelGroup numbers\n       - Dietary: \"kosher\", \"vegan\", \"halal\" → specificRequirements\n       - Accessibility: \"wheelchair\", \"accessible\" → accessibility requirements\n       - Weather: \"if nice weather\" → note in specialRequests\n    \n    7. ACTIVITY TYPES:\n       - Meals: breakfast/brunch/lunch/dinner → restaurant\n       - Coffee/work at cafe → cafe\n       - Drinks/cocktails/lounge → bar (NOT attraction)\n       - Shopping → shopping\n       - Museums/galleries → museum\n       - Parks/outdoor/walk → park\n       - Shows/entertainment → entertainment\n       - Meeting/appointment → Skip venue search BUT preserve time/location for context\n    \n    8. EDGE CASES:\n       - Conflicting requirements: Choose most logical interpretation\n       - Vague queries: Make reasonable London-appropriate suggestions\n       - Multi-day: Note day changes in flexibleTimeEntries\n    \n    SCHEMA STRUCTURE:\n    {\n      \"timeBlocks\": [\n        {\n          \"startTime\": \"10:00\",\n          \"endTime\": \"15:00\",\n          \"activity\": \"work session\",\n          \"location\": \"Canary Wharf\",\n          \"venueRequirements\": [\"quiet\", \"good wifi\", \"suitable for calls\"],\n          \"searchParameters\": {\n            \"venueType\": \"cafe\",\n            \"specificRequirements\": [\"quiet\", \"wifi\", \"power outlets\"],\n            \"ambience\": \"quiet\"\n          }\n        }\n      ],\n      \"fixedAppointments\": [\n        {\n          \"time\": \"17:00\",\n          \"duration\": 60,\n          \"activity\": \"meeting\",\n          \"location\": \"Mayfair\",\n          \"bufferBefore\": 30,\n          \"bufferAfter\": 15,\n          \"isFixed\": true\n        }\n      ],\n      \"fixedTimeEntries\": [\n        {\n          \"time\": \"HH:MM\",\n          \"activity\": \"Brief description\",\n          \"location\": \"London location\",\n          \"venuePreference\": \"specific venue type if mentioned\",\n          \"venueRequirements\": [\"quiet\", \"non-crowded\"],\n          \"searchParameters\": {\n            \"venuePreference\": \"DUPLICATE venue preference here\",\n            \"specificRequirements\": [\"array of requirements\"],\n            \"cuisine\": \"if food related\",\n            \"priceLevel\": \"budget/moderate/expensive\"\n          }\n        }\n      ],\n      \"flexibleTimeEntries\": [...same structure...],\n      \"preferences\": {\n        \"budget\": \"overall budget level\",\n        \"pace\": \"relaxed/moderate/busy\",\n        \"interests\": [\"user interests\"]\n      },\n      \"travelGroup\": {\n        \"adults\": number,\n        \"children\": number\n      },\n      \"specialRequests\": [\"any special notes\"]\n    }\n\n    Start time: 12:00\n    Date: 2025-06-02\n    \n    IMPORTANT: Count ALL activities in this request and ensure each one appears in the output.\n    \n    Here's the request to analyze:\n    Lunch in Mayfair, then coffee, then drinks in Chelsea\n    ","temperature":0.7},"rawResponse":"```json\n{\n  \"timeBlocks\": [],\n  \"fixedAppointments\": [],\n  \"fixedTimeEntries\": [\n    {\n      \"time\": \"12:00\",\n      \"activity\": \"lunch\",\n      \"location\": \"Mayfair\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"restaurant\",\n        \"cuisine\": null,\n        \"priceLevel\": null\n      }\n    },\n    {\n      \"time\": \"13:30\",\n      \"activity\": \"coffee\",\n      \"location\": \"Central London\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"cafe\",\n        \"priceLevel\": null\n      }\n    },\n    {\n      \"time\": \"15:00\",\n      \"activity\": \"drinks\",\n      \"location\": \"Chelsea\",\n      \"venuePreference\": null,\n      \"venueRequirements\": [],\n      \"searchParameters\": {\n        \"venueType\": \"bar\",\n        \"priceLevel\": null\n      }\n    }\n  ],\n  \"flexibleTimeEntries\": [],\n  \"preferences\": {\n    \"budget\": null,\n    \"pace\": \"moderate\",\n    \"interests\": []\n  },\n  \"travelGroup\": {\n    \"adults\": 1,\n    \"children\": 0\n  },\n  \"specialRequests\": []\n}\n```","service":"ai-interaction-logger","sessionId":"a969ed26-ebaf-45ad-a8b1-50b3987e477d","status":"error","timestamp":"2025-06-03T00:03:42.930Z","userQuery":"Lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] [32minfo[39m: AI Interaction {"errorDetails":"API or processing error: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","processingTimeMs":4600,"rawRequest":{"temperature":0.7},"service":"ai-interaction-logger","sessionId":"a969ed26-ebaf-45ad-a8b1-50b3987e477d","status":"error","timestamp":"2025-06-03T00:03:43.029Z","userQuery":"Lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] Gemini processing attempt failed at temperature 0.7: Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined
[0]     at attemptGeminiProcessing (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:472:13)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at processWithGemini (/Users/carlos/LondonDayPlanner-1/server/lib/geminiProcessor.ts:176:22)
[0]     at parseItineraryRequest (/Users/carlos/LondonDayPlanner-1/server/lib/nlp-fixed.ts:523:29)
[0]     at MemoryCache.getOrSet (/Users/carlos/LondonDayPlanner-1/server/lib/cache.ts:59:23)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:71:37)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25)
[0] [32minfo[39m: AI Interaction {"errorDetails":"Error: Failed to parse Gemini response as JSON: ReferenceError: defaultLocation is not defined","modelName":"gemini-1.5-pro","service":"ai-interaction-logger","sessionId":"a969ed26-ebaf-45ad-a8b1-50b3987e477d","status":"error","timestamp":"2025-06-03T00:03:43.129Z","userQuery":"Lunch in Mayfair, then coffee, then drinks in Chelsea"}
[0] New Gemini processor unavailable or failed, falling back to original method
[0] Converting Gemini result to app format: null
[0] 📝 Parsed request from cache/fetch: {
[0]   startLocation: '51.5074,-0.1278',
[0]   destinations: [ 'Chelsea' ],
[0]   fixedTimes: [],
[0]   preferences: { type: undefined, requirements: [] }
[0] }
[0] 📍 Using explicit start location from NLP: 51.5074,-0.1278
[0] 📍 Determined initial search/start location: 51.5074,-0.1278
[0] 🔧 NLP returned empty fixedTimes and activities, creating fallback activity based on original query.
[0] 🔧 Fallback activity created: [
[0]   {
[0]     description: 'Lunch in Mayfair, then coffee, then drinks in Chelsea',
[0]     location: '51.5074,-0.1278',
[0]     time: '12:00',
[0]     searchParameters: {
[0]       type: 'pub',
[0]       searchTerm: 'Lunch in Mayfair, then coffee, then drinks in Chelsea',
[0]       keywords: [],
[0]       minRating: 0,
[0]       requireOpenNow: true
[0]     },
[0]     requirements: []
[0]   }
[0] ]
[0] Parsed time "12:00" to normalized time "12:00" and Europe/London time: 12:00 PM (2025-06-01 12:00:00 GMT+1)
[0] [SERVICE DEBUG _processGeneralActivities] Called with 1 activities.
[0] Processing 1 general activities (no fixed times)
[0] Processing general activity: Lunch in Mayfair, then coffee, then drinks in Chelsea
[0] Search options for general activity at "51.5074,-0.1278": {
[0]   type: 'pub',
[0]   keywords: [],
[0]   searchTerm: 'Lunch in Mayfair, then coffee, then drinks in Chelsea',
[0]   minRating: 0,
[0]   requireOpenNow: true,
[0]   citySlug: 'london'
[0] }
[0] 🔍 [enhancedPlaceSearch] Starting enhanced search with options: {
[0]   query: 'Lunch in Mayfair, then coffee, then drinks in Chelsea',
[0]   location: '51.5074,-0.1278',
[0]   keywords: [],
[0]   type: 'pub',
[0]   preferences: {
[0]     type: 'pub',
[0]     searchTerm: 'Lunch in Mayfair, then coffee, then drinks in Chelsea',
[0]     keywords: [],
[0]     minRating: 0,
[0]     requireOpenNow: true
[0]   },
[0]   cityContext: { name: 'London', slug: 'london', timezone: 'Europe/London' }
[0] }
[0] 🏙️ [Area Intelligence] Recommending Fitzrovia for pub (score: 40)
[0]    Reasons: Known for pub, Nearby
[0] 🤖 [Gemini] Enhanced query: "best pub in Fitzrovia"
[0] 📍 [enhancedPlaceSearch] Using city center for "london"
[0] 🎯 [enhancedPlaceSearch] Using location bias: 51.5074,-0.1278 with radius 25000m
[0] 🌐 [enhancedPlaceSearch] Searching with query: "best pub in Fitzrovia"
[0] 🏙️ [enhancedPlaceSearch] After city filtering: 4 venues remain for London
[0] ✅ [enhancedPlaceSearch] Found 4 places with ratings
[0] 🎲 [enhancedPlaceSearch] Selected venue (with variety): {
[0]   name: 'Fitzrovia',
[0]   rating: 4.2,
[0]   address: '18 Goodge St, London W1T 2QF, United Kingdom'
[0] }
[0] 🔄 [enhancedPlaceSearch] Alternatives: [
[0]   { name: 'The Black Horse - Pub & Cocktail Bar', rating: 4.7 },
[0]   { name: 'Lore of the Land', rating: 4.6 },
[0]   { name: 'The George', rating: 4.5 }
[0] ]
[0] Found place for general activity: Fitzrovia
[0] Added general activity to itinerary: Fitzrovia at 2025-06-01T17:00:00.000Z
[0] DbStorage (with logging): Creating itinerary (anonymous)
[0] DbStorage (with logging): Error creating itinerary: NeonDbError: column "title" of relation "itineraries" does not exist
[0]     at execute (file:///Users/carlos/LondonDayPlanner-1/node_modules/@neondatabase/serverless/index.mjs:1556:55)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at NeonHttpPreparedQuery.execute (/Users/carlos/LondonDayPlanner-1/node_modules/src/neon-http/session.ts:68:18)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:100:27)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:512:22)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:300:32)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25) {
[0]   severity: 'ERROR',
[0]   code: '42703',
[0]   detail: undefined,
[0]   hint: undefined,
[0]   position: '34',
[0]   internalPosition: undefined,
[0]   internalQuery: undefined,
[0]   where: undefined,
[0]   schema: undefined,
[0]   table: undefined,
[0]   column: undefined,
[0]   dataType: undefined,
[0]   constraint: undefined,
[0]   file: 'parse_target.c',
[0]   line: '1066',
[0]   routine: 'checkInsertTargets',
[0]   sourceError: undefined
[0] }
[0] Using in-memory fallback for createItinerary due to database error
[0] Successfully created itinerary "Lunch in Mayfair, then coffee, then drinks in Chelsea in London" for London with ID: 6
[0] [Weather] Using cached data for 51.52,-0.13
[0] 🌤️ [/:city/plan] Retrieved weather data for itinerary
[0] 🕒 [/:city/plan] Place scheduledTime: 2025-06-01T17:00:00.000Z
[0] 🌍 [/:city/plan] Using timezone: Europe/London
[0] 🕒 [/:city/plan] Formatted time: 6:00 PM
[0] 📤 [/:city/plan] Sending response with 1 venues
[0] POST /api/london/plan 200 21207ms
[0] 📝 [/:city/plan] City-specific plan request for: London
[0] Query: I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?
[0] 🚀 [/:city/plan] Creating city-aware plan for London
[0] 🏙️ Creating plan for city: london
[0] 🚀 Creating plan for query: I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?
[0] 📝 Parsed request from cache/fetch: {
[0]   startLocation: '51.5074,-0.1278',
[0]   destinations: [],
[0]   fixedTimes: [],
[0]   preferences: { type: undefined, requirements: [] },
[0]   activities: [
[0]     {
[0]       description: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?',
[0]       location: '51.5074,-0.1278',
[0]       time: '12:00',
[0]       searchParameters: [Object],
[0]       requirements: []
[0]     }
[0]   ]
[0] }
[0] 📍 Using explicit start location from NLP: 51.5074,-0.1278
[0] 📍 Determined initial search/start location: 51.5074,-0.1278
[0] Parsed time "12:00" to normalized time "12:00" and Europe/London time: 12:00 PM (2025-06-01 12:00:00 GMT+1)
[0] [SERVICE DEBUG _processGeneralActivities] Called with 1 activities.
[0] Processing 1 general activities (no fixed times)
[0] Processing general activity: I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?
[0] Search options for general activity at "51.5074,-0.1278": {
[0]   type: 'pub',
[0]   keywords: [],
[0]   searchTerm: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?',
[0]   minRating: 0,
[0]   requireOpenNow: true,
[0]   citySlug: 'london'
[0] }
[0] 🔍 [enhancedPlaceSearch] Starting enhanced search with options: {
[0]   query: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?',
[0]   location: '51.5074,-0.1278',
[0]   keywords: [],
[0]   type: 'pub',
[0]   preferences: {
[0]     type: 'pub',
[0]     searchTerm: 'I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one?',
[0]     keywords: [],
[0]     minRating: 0,
[0]     requireOpenNow: true
[0]   },
[0]   cityContext: { name: 'London', slug: 'london', timezone: 'Europe/London' }
[0] }
[0] 🏙️ [Area Intelligence] Recommending Fitzrovia for pub (score: 40)
[0]    Reasons: Known for pub, Nearby
[0] 🤖 [Gemini] Enhanced query: "best pubs in Fitzrovia cocktails"
[0] 📍 [enhancedPlaceSearch] Using city center for "london"
[0] 🎯 [enhancedPlaceSearch] Using location bias: 51.5074,-0.1278 with radius 25000m
[0] 🌐 [enhancedPlaceSearch] Searching with query: "best pubs in Fitzrovia cocktails"
[0] 🏙️ [enhancedPlaceSearch] After city filtering: 4 venues remain for London
[0] ✅ [enhancedPlaceSearch] Found 4 places with ratings
[0] 🎲 [enhancedPlaceSearch] Selected venue (with variety): {
[0]   name: 'The Royal Cocktail Exchange',
[0]   rating: 4.9,
[0]   address: '31 Windmill St, London W1T 2JN, United Kingdom'
[0] }
[0] 🔄 [enhancedPlaceSearch] Alternatives: [
[0]   { name: 'Murder Inc. Cocktails', rating: 4.9 },
[0]   { name: 'The Black Horse - Pub & Cocktail Bar', rating: 4.7 },
[0]   {
[0]     name: 'The Cocktail Club - Cocktail Bar in Fitzrovia',
[0]     rating: 4.5
[0]   }
[0] ]
[0] Found place for general activity: The Royal Cocktail Exchange
[0] Place "The Royal Cocktail Exchange" already exists, returning existing record
[0] Added general activity to itinerary: The Royal Cocktail Exchange at 2025-06-01T17:00:00.000Z
[0] DbStorage (with logging): Creating itinerary (anonymous)
[0] DbStorage (with logging): Error creating itinerary: NeonDbError: column "title" of relation "itineraries" does not exist
[0]     at execute (file:///Users/carlos/LondonDayPlanner-1/node_modules/@neondatabase/serverless/index.mjs:1556:55)
[0]     at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
[0]     at NeonHttpPreparedQuery.execute (/Users/carlos/LondonDayPlanner-1/node_modules/src/neon-http/session.ts:68:18)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:100:27)
[0]     at DbStorageWithLogging.createItinerary (/Users/carlos/LondonDayPlanner-1/server/storage.ts:512:22)
[0]     at ItineraryPlanningService.createPlan (/Users/carlos/LondonDayPlanner-1/server/services/ItineraryPlanningService.ts:300:32)
[0]     at <anonymous> (/Users/carlos/LondonDayPlanner-1/server/routes.ts:299:25) {
[0]   severity: 'ERROR',
[0]   code: '42703',
[0]   detail: undefined,
[0]   hint: undefined,
[0]   position: '34',
[0]   internalPosition: undefined,
[0]   internalQuery: undefined,
[0]   where: undefined,
[0]   schema: undefined,
[0]   table: undefined,
[0]   column: undefined,
[0]   dataType: undefined,
[0]   constraint: undefined,
[0]   file: 'parse_target.c',
[0]   line: '1066',
[0]   routine: 'checkInsertTargets',
[0]   sourceError: undefined
[0] }
[0] Using in-memory fallback for createItinerary due to database error
[0] Successfully created itinerary "I have a lunch in Mayfair 12 -- would like a place with nice fish. Afterwards I would like to work at a nearby coffee shop. Before going to Chelsea at 7PM to meet some friends for drinks at a cocktail bar -- could you help me choose one? in London" for London with ID: 7
[0] [Weather] Using cached data for 51.52,-0.13
[0] 🌤️ [/:city/plan] Retrieved weather data for itinerary
[0] 🕒 [/:city/plan] Place scheduledTime: 2025-06-01T17:00:00.000Z
[0] 🌍 [/:city/plan] Using timezone: Europe/London
[0] 🕒 [/:city/plan] Formatted time: 6:00 PM
[0] 📤 [/:city/plan] Sending response with 1 venues
[0] POST /api/london/plan 200 2080ms
[0] SIGTERM received, shutting down gracefully...
[0] Server closed
[0] npm run dev exited with code 0
[1] 5:39:17 PM [vite] hmr update /src/components/InputScreen.tsx, /src/index.css
[1] 5:39:23 PM [vite] hmr update /src/components/InputScreen.tsx, /src/index.css
[1] 5:39:56 PM [vite] hmr update /src/components/ItineraryScreen.tsx, /src/index.css
[1] 5:51:36 PM [vite] hmr update /src/components/ItineraryScreen.tsx, /src/index.css
[1] 5:51:43 PM [vite] hmr update /src/components/ItineraryScreen.tsx, /src/index.css
[1] 6:51:10 PM [vite] hmr update /src/components/ItineraryScreen.tsx, /src/index.css
[1] 6:51:19 PM [vite] hmr update /src/components/ItineraryScreen.tsx, /src/index.css
[1] npm run dev:client exited with code 0
